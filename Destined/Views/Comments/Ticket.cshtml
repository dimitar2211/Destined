@model List<Destined.Models.TicketComment>
@{
    var ticket = ViewBag.Ticket as Destined.Models.Ticket;
    ViewData["Title"] = "Коментари към билет";
    ViewData["FullWidth"] = true;
    var currentUserId = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isAdmin = User.IsInRole("Admin");
}

<div style="position: relative; min-height: 100vh; overflow-x: hidden;">
    <partial name="_ThemeBackground" />

    <div id="page-content" style="position: relative; z-index: 10; padding: 40px 20px;">
        
        <div class="comment-wrapper">
            <h2 class="page-title">Коментари</h2>
            <h3 class="ticket-subtitle">за билет: @ticket.From ➔ @ticket.To</h3>

            <!-- New Comment Form -->
            <div class="glass-panel create-box">
                <form asp-controller="Comments" asp-action="Add" method="post">
                    <input type="hidden" name="ticketId" value="@ticket.Id" />
                    <input type="hidden" name="sort" value="@ViewBag.Sort" />
                    @if (ViewBag.Seed != null)
                    {
                        <input type="hidden" name="seed" value="@ViewBag.Seed" />
                    }

                    <div class="form-group">
                        <textarea name="content" class="glass-input" rows="3" placeholder="Напиши коментар..."></textarea>
                    </div>
                    <div style="text-align: right;">
                        <button class="btn-action primary">Публикувай</button>
                    </div>
                </form>
            </div>

            <!-- Sort & Filter -->
            @{
                var sort = ViewBag.Sort ?? "newest";
            }
            <div class="sort-container">
                <form method="get">
                    <input type="hidden" name="ticketId" value="@ticket.Id" />
                    <select name="sort" class="glass-select" onchange="this.form.submit()">
                        <option value="newest" selected="@(sort == "newest" ? "selected" : null)">Най-нови</option>
                        <option value="oldest" selected="@(sort == "oldest" ? "selected" : null)">Най-стари</option>
                        <option value="longest" selected="@(sort == "longest" ? "selected" : null)">Най-дълги</option>
                        <option value="random" selected="@(sort == "random" ? "selected" : null)">Разбъркани</option>
                    </select>
                </form>
            </div>

            <!-- Comments List -->
            @if (!Model.Any())
            {
                <div class="no-comments">
                    <p>Все още няма коментари. Бъди първият!</p>
                </div>
            }
            else
            {
                var pics = ViewBag.ProfilePictures as Dictionary<string, string>;

                <div class="comments-list">
                    @foreach (var c in Model)
                    {
                        string picUrl = null;
                        var hasPic = pics != null && pics.TryGetValue(c.UserId, out picUrl);

                        <div class="glass-comment">
                            <div class="comment-header">
                                <div class="author-info">
                                    @if (hasPic)
                                    {
                                        <img src="@picUrl" alt="@c.User.UserName" class="comment-avatar" />
                                    }
                                    <span class="author">@c.User.UserName</span>
                                </div>
                                <span class="date">@c.CreatedOn.ToString("dd.MM.yyyy HH:mm")</span>
                            </div>
                            
                            <div class="comment-body">
                                @c.Content
                            </div>

                            <div class="comment-footer">
                                <details data-id="@c.Id" class="reply-details">
                                    <summary class="btn-link">Отговори (@(c.Replies?.Count ?? 0))</summary>

                                    <div class="reply-section">
                                        <form asp-controller="Comments" asp-action="Add" method="post" class="reply-form">
                                            <input type="hidden" name="ticketId" value="@ticket.Id" />
                                            <input type="hidden" name="parentCommentId" value="@c.Id" />
                                            <input type="hidden" name="sort" value="@ViewBag.Sort" />
                                            @if (ViewBag.Seed != null)
                                            {
                                                <input type="hidden" name="seed" value="@ViewBag.Seed" />
                                            }
                                            <div style="display: flex; gap: 10px;">
                                                <textarea name="content" rows="1" class="glass-input small" placeholder="Твоят отговор..."></textarea>
                                                <button class="btn-action secondary small">Прати</button>
                                            </div>
                                        </form>

                                        @if (c.Replies != null)
                                        {
                                            foreach (var reply in c.Replies)
                                            {
                                                string replyPicUrl = null;
                                                var hasReplyPic = pics != null && pics.TryGetValue(reply.UserId, out replyPicUrl);

                                                <div class="reply-item">
                                                    <div class="reply-header">
                                                        <div class="reply-author-info">
                                                            @if (hasReplyPic)
                                                            {
                                                                <img src="@replyPicUrl" alt="@reply.User.UserName" class="reply-avatar" />
                                                            }
                                                            <span class="reply-author">@reply.User.UserName</span>
                                                        </div>
                                                        <span class="reply-content">@reply.Content</span>
                                                    </div>
                                                    
                                                    @if (currentUserId == reply.UserId || currentUserId == ticket.UserId || isAdmin)
                                                    {
                                                        <form asp-controller="Comments" asp-action="Delete" method="post" style="display:inline;">
                                                            <input type="hidden" name="id" value="@reply.Id" />
                                                            <input type="hidden" name="sort" value="@ViewBag.Sort" />
                                                            @if (ViewBag.Seed != null)
                                                            {
                                                                <input type="hidden" name="seed" value="@ViewBag.Seed" />
                                                            }
                                                            <button class="btn-text-danger">Изтрий</button>
                                                        </form>
                                                    }
                                                </div>
                                            }
                                        }
                                    </div>
                                </details>

                                @if (currentUserId == c.UserId || currentUserId == ticket.UserId || isAdmin)
                                {
                                    <form asp-controller="Comments" asp-action="Delete" method="post" style="display:inline; margin-left: auto;">
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <input type="hidden" name="sort" value="@ViewBag.Sort" />
                                        @if (ViewBag.Seed != null)
                                        {
                                            <input type="hidden" name="seed" value="@ViewBag.Seed" />
                                        }
                                        <button class="btn-text-danger">Изтрий коментара</button>
                                    </form>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            
            <div style="text-align: center; margin-top: 40px;">
                <a asp-controller="Tickets" asp-action="PublicTickets" class="btn-back">Обратно към билетите</a>
            </div>

        </div>
    </div>
</div>

<script>
    /* Preserve scroll and open details state handles */
    document.addEventListener("submit", function () {
        localStorage.setItem("scrollPos", window.scrollY);

        const openDetails = [...document.querySelectorAll("details[open]")].map(d => d.dataset.id);
        localStorage.setItem("openDetails", JSON.stringify(openDetails));
    });

    window.addEventListener("load", function () {
        const pos = localStorage.getItem("scrollPos");
        if (pos) {
            window.scrollTo(0, parseInt(pos));
            localStorage.removeItem("scrollPos");
        }

        const openDetailsJson = localStorage.getItem("openDetails");
        if(openDetailsJson) {
            const openDetails = JSON.parse(openDetailsJson);
            if (openDetails && openDetails.length > 0) {
                openDetails.forEach(id => {
                    const details = document.querySelector(`details[data-id='${id}']`);
                    if (details) details.setAttribute("open", "");
                });
            }
            localStorage.removeItem("openDetails");
        }
    });
</script>

<style>
    /* Typography */
    .page-title {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 5px;
        color: white;
        font-weight: 800;
        text-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .ticket-subtitle {
        text-align: center;
        font-size: 1.2rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 30px;
        font-weight: 500;
    }

    .comment-wrapper {
        max-width: 800px;
        margin: 0 auto;
    }

    /* Glass Panels */
    .glass-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .create-box {
        padding: 25px;
        margin-bottom: 30px;
        border-left: 5px solid #4caf50; /* Accent */
    }

    .glass-comment {
        background: rgba(255, 255, 255, 0.07);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
        transition: transform 0.2s;
    }
    .glass-comment:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.12);
    }

    /* Inputs */
    .glass-input, .glass-select {
        width: 100%;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 12px;
        border-radius: 10px;
        font-size: 1rem;
        outline: none;
        transition: 0.3s;
        font-family: inherit;
    }
    .glass-input:focus, .glass-select:focus {
        background: rgba(0, 0, 0, 0.4);
        border-color: #4caf50;
    }
    .glass-select option { background: #222; color: white; }
    .glass-input.small { padding: 8px; font-size: 0.9rem; }

    .sort-container {
        display: flex; justify-content: flex-end; margin-bottom: 15px;
    }
    .sort-container select { width: auto; min-width: 150px; }

    /* Buttons */
    .btn-action {
        padding: 10px 25px;
        border-radius: 30px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        transition: 0.3s;
        color: white;
    }
    .btn-action.primary {
        background: linear-gradient(45deg, #4caf50, #81c784);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }
    .btn-action.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    .btn-action.secondary {
        background: rgba(255, 255, 255, 0.2);
    }
    .btn-action.secondary:hover { background: rgba(255, 255, 255, 0.3); }
    .btn-action.small { padding: 8px 16px; font-size: 0.9rem; }

    .btn-text-danger {
        background: none; border: none; color: #ff5252; cursor: pointer; font-size: 0.85rem; padding: 0 5px; opacity: 0.7; transition: 0.2s;
    }
    .btn-text-danger:hover { opacity: 1; text-decoration: underline; }

    .btn-link {
        background: none; border: none; color: #64b5f6; cursor: pointer; font-weight: 600; font-size: 0.9rem; outline: none; list-style: none;
    }
    .btn-link:hover { text-decoration: underline; color: #90caf9; }
    
    .btn-back {
        color: rgba(255,255,255,0.6); text-decoration: none; transition: 0.2s;
    }
    .btn-back:hover { color: white; }

    /* Comment Structure */
    .comment-header {
        display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; align-items: center;
    }
    .author-info {
        display: flex; align-items: center; gap: 10px;
    }
    .comment-avatar {
        width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2);
    }
    .author { font-weight: 700; color: #a5d6a7; font-size: 1.1rem; }
    .date { font-size: 0.85rem; color: rgba(255,255,255,0.5); }
    .comment-body { font-size: 1rem; line-height: 1.5; margin-bottom: 15px; }
    
    .comment-footer {
        display: flex; align-items: center; justify-content: space-between;
    }

    /* Replies */
    .reply-section {
        margin-top: 15px; padding-left: 15px; border-left: 2px solid rgba(255,255,255,0.1);
    }
    .reply-form { margin-bottom: 15px; margin-top: 10px; }
    .reply-item {
        background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.95rem;
    }
    .reply-header { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 5px; }
    .reply-author-info { display: flex; align-items: center; gap: 6px; }
    .reply-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); }
    .reply-author { font-weight: 700; color: #81d4fa; }
    .reply-content { color: rgba(255,255,255,0.9); margin-left: 5px; }

    .no-comments {
        text-align: center; padding: 40px; color: rgba(255,255,255,0.5); font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.05); border-radius: 20px;
    }
</style>