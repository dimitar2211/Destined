@model Destined.Models.JournalPage

@{
    ViewData["Title"] = "Дневник";
    ViewData["FullWidth"] = true;
    bool readOnly = ViewBag.ReadOnly == true;
}

<div style="position: relative; min-height: 100vh; overflow-x: hidden;">
    <partial name="_ThemeBackground" />

    <div id="page-content" style="position: relative; z-index: 10; padding: 40px 20px;">
        
        <h2 class="page-title">Дневник за билет #@Model.TicketId <span style="font-size: 0.6em; opacity: 0.8; display: block; margin-top: 5px;">Страница @Model.PageNumber</span></h2>

        @if (readOnly && string.IsNullOrWhiteSpace(Model.Content))
        {
            <div class="alert-glass">
                Този билет все още няма създаден дневник.
            </div>
        }

        <form asp-action="SavePage" enctype="multipart/form-data" method="post" id="journalForm">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="TicketId" />
            <input type="hidden" asp-for="PageNumber" />

            @if (!readOnly)
            {
                <div class="toolbar-glass mb-4">
                    <button type="button" class="btn-tool" onclick="document.execCommand('bold', false, null)" title="Удебели"><b>B</b></button>
                    <button type="button" class="btn-tool" onclick="document.execCommand('removeFormat', false, null)" title="Изчисти формат">Tx</button>
                    <button type="button" class="btn-tool" onclick="document.execCommand('justifyLeft', false, null)" title="Ляво">⇤</button>
                    <button type="button" class="btn-tool" onclick="document.execCommand('justifyCenter', false, null)" title="Центрирай">↔</button>

                    <button type="button" class="btn-tool" onclick="setTextColor()" title="Цвят на текста">🎨</button>
                    <input type="color" id="textColorPicker" style="display:none" />

                    <label for="imageUpload" class="btn-tool" title="Добави снимка">📷</label>
                    <input type="file" id="imageUpload" accept="image/*" />

                    <label for="videoUpload" class="btn-tool" title="Добави видео">🎥</label>
                    <input type="file" id="videoUpload" accept="video/*" />
                </div>
            }

            <div id="editor-container">
                @if (readOnly)
                {
                    <div id="editor" contenteditable="false" class="paper-sheet">
                        @Html.Raw(Model.Content)
                    </div>
                }
                else
                {
                    <div id="editor" contenteditable="true" spellcheck="false" class="paper-sheet">
                        @Html.Raw(Model.Content)
                    </div>
                }
            </div>

            @if (!readOnly)
            {
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn-save">Запази страницата</button>
                </div>
            }
        </form>

        <div class="mt-4 navigation" style="text-align: center;">
            @if (Model.PageNumber > 1)
            {
                <a class="btn-nav prev" href="@Url.Action("Page", "Journal", new { ticketId = Model.TicketId, page = Model.PageNumber - 1, readOnly = ViewBag.ReadOnly })">← Предишна</a>
            }

            @if (Model.HasNextPage || !readOnly)
            {
                /* Show Next if it exists OR if we are editing (to allow creating new pages implicitly if logic allows, or just navigation) */
                /* Assuming standard behavior: Next button usually only if next page exists */
                if(Model.HasNextPage) {
                     <a class="btn-nav next" href="@Url.Action("Page", "Journal", new { ticketId = Model.TicketId, page = Model.PageNumber + 1, readOnly = ViewBag.ReadOnly })">Следваща →</a>
                }
            }
            
             <div style="margin-top: 20px;">
                <a asp-controller="Tickets" asp-action="Index" class="btn-back">Обратно към билетите</a>
            </div>
        </div>

    </div>
</div>

<style>
    /* Global Page Styles */
    .page-title {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 30px;
        color: #fff;
        font-weight: 700;
        text-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .alert-glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        max-width: 600px;
        margin: 0 auto 30px;
    }

    /* Toolbar Styles */
    .toolbar-glass {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px;
        border-radius: 50px;
        display: flex;
        justify-content: center;
        gap: 10px;
        max-width: 700px;
        margin: 0 auto 20px;
        flex-wrap: wrap;
    }

    .btn-tool {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.1rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-tool:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.1);
    }

    input[type="file"] { display: none; }

    /* Paper/Editor Styles */
    #editor-container {
        display: flex;
        justify-content: center;
        perspective: 1000px;
    }

    .paper-sheet {
        position: relative;
        width: 794px; /* A4 width roughly at 96dpi */
        height: 1123px; /* A4 height */
        background-color: #fdfbf7; /* Off-white paper */
        background-image: 
            linear-gradient(#e1e1e1 1px, transparent 1px), /* Rules */
            linear-gradient(90deg, #ff9ca8 1px, transparent 1px); /* Margin line */
        background-size: 100% 30px, 100% 100%;
        background-position: 0 30px, 60px 0; /* Align rules and margin */
        
        box-shadow: 
            0 1px 1px rgba(0,0,0,0.15), 
            0 10px 0 -5px #eee, 
            0 10px 1px -4px rgba(0,0,0,0.15), 
            0 20px 0 -10px #eee, 
            0 20px 1px -9px rgba(0,0,0,0.15),
            0 30px 40px rgba(0,0,0,0.4); /* Stacked effect + drop shadow */
        
        padding: 60px 80px 60px 80px; /* Padding inside margin */
        color: #2c3e50;
        font-family: 'Courier New', Courier, monospace; /* Typewriter/handwritten feel */
        font-size: 18px;
        line-height: 30px; /* Match background-size height */
        outline: none;
        overflow: hidden;
        border-radius: 2px;
    }
    
    @@media (max-width: 850px) {
        .paper-sheet {
            width: 100%;
            height: auto;
            min-height: 800px;
            padding: 40px 20px 40px 50px;
            background-position: 0 30px, 40px 0;
            font-size: 16px;
        }
    }

    /* Resizable Media Wrappers */
    .resizable-wrapper {
        position: absolute;
        resize: both;
        overflow: hidden;
        cursor: move;
        width: 160px;
        height: auto;
        border: 2px dashed rgba(0,0,0,0.1);
        transition: border-color 0.2s;
    }
    .resizable-wrapper:focus, .resizable-wrapper:hover {
        border-color: #00796b;
    }
    .resizable-wrapper img, .resizable-wrapper video {
        width: 100%; height: 100%; object-fit: contain; pointer-events: none;
    }

    /* Buttons */
    .btn-save {
        background: linear-gradient(45deg, #11998e, #38ef7d);
        border: none;
        padding: 12px 40px;
        border-radius: 30px;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        transition: 0.3s;
    }
    .btn-save:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

    .btn-nav {
        display: inline-block;
        background: rgba(255,255,255,0.1);
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 20px;
        margin: 0 10px;
        transition: 0.3s;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-nav:hover { background: rgba(255,255,255,0.2); }
    
    .btn-back {
        color: #aaa; text-decoration: none; font-size: 0.9rem; transition: 0.3s;
    }
    .btn-back:hover { color: white; }

</style>

@section Scripts {
    <script>
        const isReadOnly = @readOnly.ToString().ToLower();
        const editor = document.getElementById('editor');

        let draggedWrapper = null;
        let offsetX = 0;
        let offsetY = 0;

        function setTextColor() {
            document.getElementById('textColorPicker').click();
        }

        document.getElementById('textColorPicker').addEventListener('input', function () {
            document.execCommand('foreColor', false, this.value);
        });

        /* ------------------------- MAKE DRAGGABLE ------------------------- */
        function makeDraggable(wrapper) {
            wrapper.classList.add('resizable-wrapper');
            wrapper.tabIndex = 0;

            wrapper.addEventListener('mousedown', function (e) {
                const buffer = 10;
                const isInResizeZone =
                    e.offsetX > wrapper.clientWidth - buffer ||
                    e.offsetY > wrapper.clientHeight - buffer;
                if (isInResizeZone) return;

                draggedWrapper = wrapper;
                offsetX = e.offsetX;
                offsetY = e.offsetY;
            });

            wrapper.addEventListener('mousedown', () => wrapper.focus());

            wrapper.addEventListener('dblclick', () => {
                const deleteHandler = (e) => {
                    if (e.key === "Backspace") {
                        wrapper.remove();
                        document.removeEventListener('keydown', deleteHandler);
                    }
                };
                document.addEventListener('keydown', deleteHandler);
            });
        }

        document.addEventListener('mousemove', function (e) {
            if (draggedWrapper) {
                const rect = editor.getBoundingClientRect();
                let x = e.clientX - rect.left - offsetX;
                let y = e.clientY - rect.top - offsetY;

                x = Math.max(0, Math.min(x, editor.clientWidth - draggedWrapper.offsetWidth));
                y = Math.max(0, Math.min(y, editor.clientHeight - draggedWrapper.offsetHeight));

                draggedWrapper.style.left = x + 'px';
                draggedWrapper.style.top = y + 'px';
            }
        });

        document.addEventListener('mouseup', function () {
            draggedWrapper = null;
        });

        /* ---------------------------- UPLOAD IMAGE ---------------------------- */
        const imageInput = document.getElementById('imageUpload');
        if (imageInput) {
            imageInput.addEventListener('change', function () {
                const file = this.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('image', file);

                fetch('/Journal/UploadImage', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.location) {
                            const wrapper = document.createElement('div');
                            wrapper.style.left = '10px';
                            wrapper.style.top = '10px';

                            const img = document.createElement('img');
                            img.src = data.location;

                            wrapper.appendChild(img);
                            makeDraggable(wrapper);
                            editor.appendChild(wrapper);
                        } else {
                            alert('Грешка при качване.');
                        }
                    })
                    .catch(() => alert('Грешка при качване.'));

                this.value = '';
            });
        }

        /* ---------------------------- UPLOAD VIDEO ---------------------------- */
        const videoInput = document.getElementById('videoUpload');
        if (videoInput) {
            videoInput.addEventListener('change', function () {
                const file = this.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('video', file);

                fetch('/Journal/UploadVideo', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.location) {
                            const wrapper = document.createElement('div');
                            wrapper.style.left = '10px';
                            wrapper.style.top = '10px';

                            const video = document.createElement('video');
                            video.src = data.location;
                            video.autoplay = true;
                            video.loop = true;
                            video.muted = true;
                            video.playsInline = true;
                            video.controls = false;
                            video.style.pointerEvents = 'none';
                            video.style.width = '100%';
                            video.style.height = '100%';
                            video.style.objectFit = 'contain';

                            wrapper.appendChild(video);
                            makeDraggable(wrapper);
                            editor.appendChild(wrapper);
                        } else {
                            alert('Грешка при качване.');
                        }
                    })
                    .catch(() => alert('Грешка при качване.'));

                this.value = '';
            });
        }

        /* ---------------------------- SUBMIT ---------------------------- */
        document.getElementById('journalForm').addEventListener('submit', function () {
            const content = editor.innerHTML;
            const hiddenContentInput = document.createElement('textarea');
            hiddenContentInput.name = "Content";
            hiddenContentInput.style.display = 'none';
            hiddenContentInput.value = content;
            this.appendChild(hiddenContentInput);
        });

        /* ---------------------------- ON LOAD ---------------------------- */
        window.onload = () => {
            const wrappers = editor.querySelectorAll('.resizable-wrapper');

            if (!isReadOnly) {
                wrappers.forEach(makeDraggable);
            } else {
                wrappers.forEach(wrapper => {
                    wrapper.style.pointerEvents = 'none';
                });
            }
        };

        /* ------------------------- INPUT LIMITER ------------------------- */
        if (!isReadOnly) {
            let lastValidContent = editor.innerHTML;

            editor.addEventListener('input', function (e) {
                if (editor.scrollHeight > editor.clientHeight + 1) {
                    editor.innerHTML = lastValidContent;

                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(editor);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);

                    e.preventDefault();
                    return;
                }

                lastValidContent = editor.innerHTML;

                const nextBtn = document.querySelector('.navigation a.next-btn');
                if (nextBtn) {
                    const hasText = editor.textContent.trim().length > 0;
                    const hasMedia = editor.querySelectorAll('.resizable-wrapper').length > 0;
                    nextBtn.style.display = (hasText || hasMedia) ? 'inline-block' : 'none';
                }
            });
        }
    </script>
}
