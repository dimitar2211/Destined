@model List<Destined.Models.Ticket>

@{
    ViewData["Title"] = "–ö–∞—Ä—Ç–∞ –Ω–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è—Ç–∞";
    ViewData["FullWidth"] = true;
    
    // Group tickets by country for easier JS processing
    // We will create a dictionary: CountryName -> List of Tickets
    var ticketsByCountry = Model
        .Where(t => !string.IsNullOrEmpty(t.Country))
        .GroupBy(t => t.Country)
        .ToDictionary(g => g.Key, g => g.ToList());

    var ticketsJson = System.Text.Json.JsonSerializer.Serialize(ticketsByCountry);
}

<!-- Include jsVectorMap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css" />

<div style="position: relative; min-height: 100vh; overflow-x: hidden;">
    <partial name="_ThemeBackground" />

    <div id="page-content" style="position: relative; z-index: 10; padding: 40px 20px;">
        <div class="map-wrapper">
            <h1 class="page-title">–¢–≤–æ—è—Ç–∞ <span class="gradient-text">–ö–∞—Ä—Ç–∞</span></h1>
            
            <div class="actions-bar">
                 <a asp-action="Index" class="btn-back">‚¨Ö –û–±—Ä–∞—Ç–Ω–æ –∫—ä–º –±–∏–ª–µ—Ç–∏—Ç–µ</a>
            </div>

            <div class="completion-banner">
                <span class="completion-label">–ó–∞–≤—ä—Ä—à–µ–Ω–æ—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞:</span>
                <span class="completion-value"><span id="completion-pct">0</span>%</span>
            </div>

            <div class="map-card">
                <div id="world-map" style="width: 100%; height: 600px;"></div>
                <div class="map-instruction">üí° –ö–ª–∏–∫–Ω–∏ –≤—ä—Ä—Ö—É –æ—Ü–≤–µ—Ç–µ–Ω–∞ –¥—ä—Ä–∂–∞–≤–∞, –∑–∞ –¥–∞ –≤–∏–¥–∏—à –±–∏–ª–µ—Ç–∏—Ç–µ —Å–∏!</div>
            </div>
            
            <div class="stats-card">
                <h3>–ü–æ—Å–µ—Ç–µ–Ω–∏ –¥—ä—Ä–∂–∞–≤–∏: <span class="highlight-count">@ticketsByCountry.Count</span></h3>
                <div class="country-tags">
                    @foreach (var country in ticketsByCountry.Keys)
                    {
                        <span class="country-tag">@country</span>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal/Panel -->
<div id="ticket-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">√ó</button>
        <h2 id="modal-country-title">Country Name</h2>
        <div id="modal-tickets-list" class="tickets-scroll">
            <!-- Tickets will be injected here -->
        </div>
    </div>
</div>

<!-- Include jsVectorMap JS and Map -->
<script src="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/js/jsvectormap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/maps/world-merc.js"></script>

<script>
    // Data from Model
    const ticketsData = @Html.Raw(ticketsJson);
    
    // --- Country Mapping Logic ---
    const countryMapping = {
        "–ë—ä–ª–≥–∞—Ä–∏—è": "BG", "Bulgaria": "BG",
        "–°–ê–©": "US", "USA": "US", "United States": "US",
        "–ì–µ—Ä–º–∞–Ω–∏—è": "DE", "Germany": "DE",
        "–§—Ä–∞–Ω—Ü–∏—è": "FR", "France": "FR",
        "–ò—Ç–∞–ª–∏—è": "IT", "Italy": "IT",
        "–ò—Å–ø–∞–Ω–∏—è": "ES", "Spain": "ES",
        "–ì—ä—Ä—Ü–∏—è": "GR", "Greece": "GR",
        "–¢—É—Ä—Ü–∏—è": "TR", "Turkey": "TR",
        "–†—É–º—ä–Ω–∏—è": "RO", "Romania": "RO",
        "–°—ä—Ä–±–∏—è": "RS", "Serbia": "RS",
        "–ú–∞–∫–µ–¥–æ–Ω–∏—è": "MK", "Macedonia": "MK", "North Macedonia": "MK",
        "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è": "GB", "UK": "GB", "United Kingdom": "GB", "–ê–Ω–≥–ª–∏—è": "GB",
        "–†—É—Å–∏—è": "RU", "Russia": "RU",
        "–ö–∏—Ç–∞–π": "CN", "China": "CN",
        "–Ø–ø–æ–Ω–∏—è": "JP", "Japan": "JP",
        "–ê–≤—Å—Ç—Ä–∏—è": "AT", "Austria": "AT",
        "–ë–µ–ª–≥–∏—è": "BE", "Belgium": "BE",
        "–®–≤–µ–π—Ü–∞—Ä–∏—è": "CH", "Switzerland": "CH",
        "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥–∏—è": "NL", "Netherlands": "NL", "–•–æ–ª–∞–Ω–¥–∏—è": "NL",
        "–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è": "PT", "Portugal": "PT",
        "–ü–æ–ª—à–∞": "PL", "Poland": "PL",
        "–ß–µ—Ö–∏—è": "CZ", "Czech Republic": "CZ",
        "–£–Ω–≥–∞—Ä–∏—è": "HU", "Hungary": "HU",
        "–•—ä—Ä–≤–∞—Ç–∏—è": "HR", "Croatia": "HR",
        "–£–∫—Ä–∞–π–Ω–∞": "UA", "Ukraine": "UA",
        // Extended Mapping
        "–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω": "AZ", "Azerbaijan": "AZ",
        "–ê–Ω–¥–æ—Ä–∞": "AD", "–ê–Ω–¥–æ—Ä—Ä–∞": "AD", "Andorra": "AD",
        "–°–ª–æ–≤–∞–∫–∏—è": "SK", "Slovakia": "SK",
        "–°–ª–æ–≤–µ–Ω–∏—è": "SI", "Slovenia": "SI",
        "–ß–µ—Ä–Ω–∞ –≥–æ—Ä–∞": "ME", "Montenegro": "ME",
        "–ë–æ—Å–Ω–∞ –∏ –•–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞": "BA", "Bosnia and Herzegovina": "BA",
        "–ú–æ–ª–¥–æ–≤–∞": "MD", "Moldova": "MD",
        "–ê–ª–±–∞–Ω–∏—è": "AL", "Albania": "AL",
        "–ö–æ—Å–æ–≤–æ": "XK", "Kosovo": "XK",
        "–ö–∏–ø—ä—Ä": "CY", "Cyprus": "CY",
        "–ú–∞–ª—Ç–∞": "MT", "Malta": "MT",
        "–õ–∏—Ö—Ç–µ–Ω—â–∞–π–Ω": "LI", "Liechtenstein": "LI",
        "–°–∞–Ω –ú–∞—Ä–∏–Ω–æ": "SM", "San Marino": "SM",
        "–ú–æ–Ω–∞–∫–æ": "MC", "Monaco": "MC",
        "–õ—é–∫—Å–µ–º–±—É—Ä–≥": "LU", "Luxembourg": "LU",
        "–®–≤–µ—Ü–∏—è": "SE", "Sweden": "SE",
        "–ù–æ—Ä–≤–µ–≥–∏—è": "NO", "Norway": "NO",
        "–§–∏–Ω–ª–∞–Ω–¥–∏—è": "FI", "Finland": "FI",
        "–î–∞–Ω–∏—è": "DK", "Denmark": "DK",
        "–ò—Ä–ª–∞–Ω–¥–∏—è": "IE", "Ireland": "IE",
        "–ò—Å–ª–∞–Ω–¥–∏—è": "IS", "Iceland": "IS",
        "–ï—Å—Ç–æ–Ω–∏—è": "EE", "Estonia": "EE",
        "–õ–∞—Ç–≤–∏—è": "LV", "Latvia": "LV",
        "–õ–∏—Ç–≤–∞": "LT", "Lithuania": "LT",
        "–ë–µ–ª–∞—Ä—É—Å": "BY", "Belarus": "BY",
        "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω": "KZ", "Kazakhstan": "KZ",
        "–ê—Ä–º–µ–Ω–∏—è": "AM", "Armenia": "AM",
        "–ì—Ä—É–∑–∏—è": "GE", "Georgia": "GE"
    };

    const codeToNameMap = {}; 
    const selectedRegions = [];

    // Parse data to find regions
    try {
        Object.keys(ticketsData).forEach(name => {
            let code = null;
            if (name.length === 2 && name === name.toUpperCase()) {
                code = name;
            } else {
                code = countryMapping[name.trim()] || countryMapping[name.trim().charAt(0).toUpperCase() + name.trim().slice(1)];
            }

            if (code) {
                selectedRegions.push(code);
                codeToNameMap[code] = name; 
            }
        });
    } catch (e) {
        console.error("Error parsing ticket data:", e);
    }

    function updateCompletionBar(visited, total) {
        const pct = total > 0 ? Math.round((visited / total) * 100) : 0;
        document.getElementById('completion-pct').textContent = pct;
    }

    document.addEventListener("DOMContentLoaded", function () {
        try {
            if (typeof jsVectorMap === 'undefined') {
                throw new Error("jsVectorMap library not loaded!");
            }

            const map = new jsVectorMap({
                selector: "#world-map",
                map: "world_merc",
                zoomButtons: true,
                zoomOnScroll: false,
                regionStyle: {
                    initial: {
                        fill: "#CFD8DC",
                        stroke: "#607D8B",
                        strokeWidth: 0.5,
                        fillOpacity: 1
                    },
                    hover: {
                        fillOpacity: 0.8,
                        cursor: 'pointer'
                    },
                    selected: {
                        fill: "#4CAF50"
                    }
                },
                selectedRegions: selectedRegions,
                
                onRegionClick(event, code) {
                    const countryName = codeToNameMap[code];
                    if (countryName && ticketsData[countryName]) {
                        showTicketsForCountry(countryName, ticketsData[countryName]);
                    }
                },
                
                onRegionTooltipShow(event, tooltip, code) {
                    const countryName = codeToNameMap[code];
                    if (countryName) {
                        const count = ticketsData[countryName].length;
                        tooltip.text(tooltip.text() + ` (${count} –±–∏–ª–µ—Ç–∞)`);
                    }
                }
            });

            // Calculate completion using the actual map's region count
            const totalCountries = Object.keys(map.regions || {}).length || 247;
            updateCompletionBar(selectedRegions.length, totalCountries);

        } catch (err) {
            console.error(err);
            document.getElementById('world-map').innerHTML = `<div style="color:white; text-align:center; padding:20px;">Unable to load map. Please check your internet connection or try again later.<br><small>${err.message}</small></div>`;
            // Fallback: still show stats with default total
            updateCompletionBar(selectedRegions.length, 247);
        }
    });

    function showTicketsForCountry(countryName, tickets) {
        document.getElementById('modal-country-title').innerText = countryName;
        const listContainer = document.getElementById('modal-tickets-list');
        listContainer.innerHTML = '';

        tickets.forEach(ticket => {
            const date = new Date(ticket.DepartureTime).toLocaleDateString('bg-BG');
            const time = new Date(ticket.DepartureTime).toLocaleTimeString('bg-BG', {hour: '2-digit', minute:'2-digit'});
            
            const card = document.createElement('div');
            card.className = 'ticket-mini-card';
            card.innerHTML = `
                <div class="ticket-header">
                    <span class="route">${ticket.From || '???'} ‚ûù ${ticket.To}</span>
                    <span class="date">${date}</span>
                </div>
                <div class="ticket-details">
                    <div>üïí ${time}</div>
                    <div>üë• ${ticket.NumberOfPassengers} –ø—ä—Ç–Ω–∏—Ü–∏</div>
                </div>
                <div class="ticket-id">ID: ${ticket.Id}</div>
            `;
            listContainer.appendChild(card);
        });

        document.getElementById('ticket-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('ticket-modal').classList.remove('active');
    }
    
    // Close on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('ticket-modal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

<style>
    .map-wrapper { max-width: 1200px; margin: 0 auto; }
    .page-title { font-size: 3rem; font-weight: 800; text-align: center; margin-bottom: 2rem; color: #fff; }
    .gradient-text { background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .actions-bar { margin-bottom: 20px; text-align: left; }

    /* Completion banner */
    .completion-banner {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    .completion-label {
        color: rgba(255,255,255,0.75);
        font-size: 1rem;
        font-weight: 600;
    }
    .completion-value {
        font-size: 1.4rem;
        font-weight: 800;
        color: #4CAF50;
    }
    .btn-back { 
        color: #fff; text-decoration: none; font-weight: 600; font-size: 1.1rem; 
        display: inline-flex; align-items: center; padding: 10px 20px; 
        background: rgba(255,255,255,0.1); border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
        transition: 0.3s; 
    }
    .btn-back:hover { 
        background: rgba(255,255,255,0.2); transform: translateX(-5px); color: #fff; 
    }

    .map-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        margin-bottom: 30px;
        overflow: hidden; 
        position: relative;
    }
    .map-instruction {
        text-align: center; color: rgba(255,255,255,0.7); margin-top: 10px; font-style: italic;
    }
    
    .stats-card {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        padding: 25px;
        color: #fff;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .highlight-count { color: #4CAF50; font-size: 1.5em; font-weight: bold; }
    .country-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .country-tag {
        background: linear-gradient(145deg, #4CAF50, #45a049);
        color: white;
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    
    .jvm-zoom-btn { background-color: #37474f !important; border: 1px solid #546e7a !important; padding: 3px; border-radius: 4px; color: white !important; font-weight: bold; }
    .jvm-tooltip { background-color: #333 !important; border-radius: 3px !important; color: white !important; font-family: sans-serif; padding: 5px 10px !important; z-index: 1000; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0; transition: opacity 0.3s ease;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    .modal-content {
        background: #fff;
        width: 90%; max-width: 500px;
        border-radius: 20px;
        padding: 25px;
        position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        animation: slideUp 0.3s ease;
        color: #333;
    }
    @@keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; }}
    
    .close-btn {
        position: absolute; top: 15px; right: 20px;
        background: none; border: none; font-size: 2rem;
        cursor: pointer; color: #666; transition: 0.2s;
    }
    .close-btn:hover { color: #f44336; }
    
    #modal-country-title { margin-top: 0; margin-bottom: 20px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    
    .tickets-scroll { max-height: 60vh; overflow-y: auto; padding-right: 5px; }
    
    .ticket-mini-card {
        background: #f8f9fa;
        border-left: 5px solid #4CAF50;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: transform 0.2s;
    }
    .ticket-mini-card:hover { transform: translateX(5px); }
    
    .ticket-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; color: #333; }
    .ticket-details { display: flex; justify-content: space-between; font-size: 0.9rem; color: #666; }
    .ticket-id { font-size: 0.75rem; color: #aaa; text-align: right; margin-top: 5px; }
</style>
