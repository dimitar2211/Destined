@model IEnumerable<Destined.Models.Ticket>

@{
    ViewData["Title"] = "Билети";
    ViewData["FullWidth"] = true;
}

@Html.AntiForgeryToken()

<!-- Wrapper for full-height background positioning -->
<div style="position: relative; min-height: 100vh; overflow-x: hidden;">
    <partial name="_ThemeBackground" />

    <div id="page-content" style="position: relative; z-index: 10; padding: 40px 20px;">
        <div class="ticket-wrapper">
            <h1 class="page-title">Твоите <span class="gradient-text">Билети</span></h1>

            <!-- Animated Quote -->
            <div class="quote-container" onclick="toggleText()">
                <p class="animated-text">
                    <span id="first-word">Спомените...</span>
                </p>
                <div id="more-text">
                    <p>са нещо безценно, което трябва да пазим и носим със себе си навсякъде, където отиваме.</p>
                    <p>Понякога именно в най-неочакваните места – докато обикаляме света или просто вървим по непозната улица с хората, които обичаме най-много – се случват най-незабравимите моменти.</p>
                    <p>Не поставяй граници на приключенията си!</p>
                    <p>Винаги можеш да създадеш нови спомени – без значение дали тръгваш от вкъщи до магазина на съседната пресечка или пътуваш към Париж.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="new-ticket">
                <a asp-action="Create" class="btn-primary-glow">Нов билет 🚀</a>
                <a asp-controller="Tickets" asp-action="PublicTickets" class="btn-secondary-glass">Публични билети 🌍</a>
            </div>

            @if (!Model.Any())
            {
                <div class="no-tickets-card">
                    <p>Все още нямаш билети. Създай първия си спомен сега!</p>
                </div>
            }
            else
            {
                <div id="ticket-list">
                    @foreach (var ticket in Model)
                    {
                        <div class="real-ticket" data-id="@ticket.Id">
                            <div class="ticket-left" style="background:@ticket.LeftColor;">
                                @{
                                    string shortFrom = ticket.From.Length > 10 ? ticket.From.Substring(0, 10) + "…" : ticket.From;
                                    string shortTo = ticket.To.Length > 10 ? ticket.To.Substring(0, 10) + "…" : ticket.To;
                                    string textColor = string.IsNullOrEmpty(ticket.TextColor) ? "#000000" : ticket.TextColor;
                                }
                                <h2 style="color:@textColor">@shortFrom ➔ @shortTo</h2>
                                <p style="color:@textColor"><strong>Дата и час:</strong> @ticket.DepartureTime.ToString("dd.MM.yyyy HH:mm")</p>
                                <p style="color:@textColor"><strong>Пътници:</strong> @ticket.NumberOfPassengers</p>
                                @if (!string.IsNullOrEmpty(ticket.Country))
                                {
                                    <p style="color:@textColor"><strong>Държава:</strong> @ticket.Country</p>
                                }
                            </div>

                            <div class="ticket-center-wrapper">
                                <div class="ticket-center">
                                    <div class="perforation"></div>
                                </div>
                            </div>

                            <div class="ticket-right" style="background:@ticket.RightColor;">
                                <div class="barcode"></div>
                                <div class="serial-number">ID: @ticket.Id</div>
                                <div class="actions">
                                    <a asp-action="Details" asp-route-id="@ticket.Id" class="btn btn-detail" title="Детайли">Детайли</a>
                                    <a asp-action="Edit" asp-route-id="@ticket.Id" class="btn btn-edit" title="Редактирай">Редактирай</a>
                                    <a asp-action="Delete" asp-route-id="@ticket.Id" class="btn btn-delete" title="Изтрий">Изтрий</a>
                                    <a asp-controller="Journal" asp-action="Page" asp-route-ticketId="@ticket.Id" asp-route-page="1" class="btn btn-journal" title="Дневник">Дневник</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<script>
    function toggleText() {
        const moreText = document.getElementById("more-text");
        moreText.classList.toggle("show");
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ticketList = document.getElementById('ticket-list');
        if (ticketList) {
            new Sortable(ticketList, {
                animation: 150,
                handle: ".real-ticket",
                ghostClass: 'sortable-ghost',
                onEnd: function () {
                    const orderedIds = Array.from(ticketList.children).map(el => el.getAttribute('data-id'));
                    fetch('@Url.Action("UpdateOrder", "Tickets")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify(orderedIds)
                    });
                }
            });
        }
    });
</script>

<style>
    /* Specific styles for Index page elements not handled by theme partial */
    
    .ticket-wrapper { position: relative; max-width: 900px; margin: 0 auto; }
    .page-title { font-size: 3rem; font-weight: 800; text-align: center; margin-bottom: 2rem; }
    .gradient-text { background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    /* Quote Box */
    .quote-container {
        background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 40px; cursor: pointer; transition: 0.3s;
    }
    .quote-container:hover { background: rgba(255,255,255,0.1); }
    .animated-text { font-size: 1.4rem; font-weight: 700; color: #fbbf24; margin: 0; }
    #more-text { max-height: 0; overflow: hidden; transition: 0.5s ease; opacity: 0; margin-top: 10px; color: #cbd5e1; }
    #more-text.show { max-height: 300px; opacity: 1; }

    /* Buttons */
    .new-ticket { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
    .btn-primary-glow, .btn-secondary-glass { padding: 12px 28px; border-radius: 50px; text-decoration: none; font-weight: 600; font-size: 1rem; transition: 0.3s; }
    .btn-primary-glow { background: linear-gradient(45deg, #3b82f6, #8b5cf6); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
    .btn-primary-glow:hover { transform: translateY(-3px); box-shadow: 0 0 25px rgba(59, 130, 246, 0.8); color: white; }
    .btn-secondary-glass { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; }
    .btn-secondary-glass:hover { background: rgba(255,255,255,0.2); transform: translateY(-3px); color: white; }

    .no-tickets-card { text-align: center; padding: 50px; color: #64748b; font-size: 1.2rem; background: rgba(255,255,255,0.02); border-radius: 20px; border: 2px dashed rgba(255,255,255,0.1); }

    /* Standard Ticket Styles */
    .real-ticket {
        display: flex; background: linear-gradient(145deg, #fafafa, #e6e6e6); border-radius: 15px; margin-bottom: 30px;
        /* Replaced box-shadow with drop-shadow for mask support, kept inset via simple box-shadow (inner only) if possible, but drop-shadow is better for cutouts */
        filter: drop-shadow(0 10px 10px rgba(0,0,0,0.15));
        overflow: hidden; cursor: default; transition: transform 0.3s ease, filter 0.3s ease; border: 1.5px solid #bbb; position: relative; font-weight: 600; user-select: none; color: #333;
        
        /* Mask for transparent notches */
        -webkit-mask: 
            radial-gradient(circle at center top, transparent 15px, black 15.5px) top center / 100% 51% no-repeat,
            radial-gradient(circle at center bottom, transparent 15px, black 15.5px) bottom center / 100% 51% no-repeat;
        mask: 
            radial-gradient(circle at center top, transparent 15px, black 15.5px) top center / 100% 51% no-repeat,
            radial-gradient(circle at center bottom, transparent 15px, black 15.5px) bottom center / 100% 51% no-repeat;
    }
    .real-ticket:hover { transform: translateY(-6px); filter: drop-shadow(0 18px 20px rgba(0,0,0,0.3)); border-color: #4caf50; }
    .ticket-left, .ticket-right { padding: 25px 30px; flex: 1; position: relative; z-index: 10; }
    .ticket-left { background: #e0f2f1; border-right: 1.5px dashed #999; display: flex; flex-direction: column; justify-content: center; }
    .ticket-left h2 { font-size: 2rem; margin-bottom: 12px; color: #00796b; text-shadow: 0 1px 1px #a0d4cf; letter-spacing: 1.2px; }
    .ticket-left p { font-size: 1.1rem; color: #004d40; margin: 6px 0; }
    
    .ticket-center-wrapper { width: 30px; display: flex; flex-direction: column; justify-content: center; margin: 0; background: transparent; }
    .ticket-center { width: 30px; height: 100%; background: repeating-linear-gradient( to bottom, transparent, transparent 8px, #999 8px, #999 10px ); position: relative; }
    
    /* Removed pseudo-element notches as they are now handled by mask */
    .ticket-right { background: #fff; box-shadow: inset 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; border-left: 1.5px dashed #999; }
    .barcode { width: 100%; height: 60px; background: repeating-linear-gradient( to right, #000, #000 3px, #fff 3px, #fff 6px, #000 6px, #000 9px, #fff 9px, #fff 12px, #000 12px, #000 15px, #fff 15px, #fff 18px ); border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); margin-bottom: 18px; }
    .serial-number { font-size: 0.9rem; font-family: 'Courier New', Courier, monospace; color: #666; margin-bottom: 15px; text-align: center; user-select: text; }
    .actions { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 5px; }
    .btn { padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: background 0.3s ease, transform 0.2s ease; box-shadow: 0 3px 8px rgba(0,0,0,0.15); border: none; color: white; display: inline-block; text-align: center; }
    .btn-detail { background: #2196f3; } .btn-edit { background: #ff9800; } .btn-delete { background: #f44336; } .btn-journal { background: #9c27b0; }
    .btn:hover { transform: translateY(-3px); color: white; }

    @@media (max-width: 768px) {
        .real-ticket { flex-direction: column; } .ticket-left { border-radius: 15px 15px 0 0; border-right: none; } .ticket-center-wrapper { display: none; } .ticket-right { border-radius: 0 0 15px 15px; border-left: none; }
    }
</style>
