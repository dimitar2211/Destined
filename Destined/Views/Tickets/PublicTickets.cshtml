@model IEnumerable<Destined.Models.Ticket>

@{
    ViewData["Title"] = "Публични билети";
    ViewData["FullWidth"] = true;
    var currentUserId = User.Identity != null && User.Identity.IsAuthenticated
        ? User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
        : null;
}

@functions {
    string ShortenUserName(string userName)
    {
        if (string.IsNullOrEmpty(userName))
            return "Непознат";

        int atIndex = userName.IndexOf('@');
        if (atIndex == -1)
            return userName;

        return userName.Substring(0, atIndex);
    }
}

<div style="position: relative; min-height: 100vh; overflow-x: hidden;">
    <partial name="_ThemeBackground" />

    <div id="page-content" style="position: relative; z-index: 10; padding: 40px 20px;">
        
        <h1 class="page-title">Публични билети</h1>

        @if (TempData["Error"] != null)
        {
            <div class="alert-glass error-alert">
                @TempData["Error"]
            </div>
        }
        @if (TempData["Message"] != null)
        {
            <div class="alert-glass success-alert">
                @TempData["Message"]
            </div>
        }

        <div class="controls-container">
            <form method="get" asp-action="PublicTickets" style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap;">
                <input type="text" name="searchCountry" value="@ViewData["SearchCountry"]" placeholder="Търси държава..." class="glass-input" />
                <button type="submit" class="btn-glass">Търси</button>
                @if (ViewData["SearchCountry"] != null)
                {
                    <a href="@Url.Action("PublicTickets")" class="btn-clear" title="Изчисти търсенето">✖</a>
                }
            </form>

            <select id="sortSelect" class="glass-select">
                <option value="random">Всички разбъркани</option>
                <option value="mineFirst">Моите билети най-отгоре</option>
                <option value="foreignOnly">Само чужди билети</option>
            </select>
        </div>

        <div class="ticket-wrapper">
            @if (!Model.Any())
            {
                <div class="no-tickets-glass">
                    <p>Все още няма публични билети.</p>
                </div>
            }
            else
            {
                foreach (var ticket in Model)
                {
                    string textColor = string.IsNullOrEmpty(ticket.TextColor) ? "#000000" : ticket.TextColor;
                    bool isMine = ticket.UserId == currentUserId;

                    <div class="real-ticket" data-mine="@isMine.ToString().ToLower()">
                        <div class="ticket-left" style="background:@ticket.LeftColor;">
                            <h2 style="color:@textColor">@ticket.From ➔ @ticket.To</h2>
                            <p style="color:@textColor"><strong>Дата:</strong> @ticket.DepartureTime.ToString("dd.MM.yyyy HH:mm")</p>
                            <p style="color:@textColor"><strong>Пътници:</strong> @ticket.NumberOfPassengers</p>
                            @if (!string.IsNullOrEmpty(ticket.Country))
                            {
                                <p style="color:@textColor"><strong>Държава:</strong> @ticket.Country</p>
                            }
                            <p style="color:@textColor"><strong>От:</strong> @ShortenUserName(ticket.User?.UserName)</p>
                        </div>
                        
                        <div class="ticket-center-wrapper">
                            <div class="ticket-center"></div>
                        </div>

                        <div class="ticket-right" style="background:@ticket.RightColor;">
                            <div class="barcode"></div>
                            <div class="actions">
                                <a asp-controller="Journal" asp-action="Page"
                                   asp-route-ticketId="@ticket.Id"
                                   asp-route-page="1"
                                   asp-route-readOnly="true"
                                   class="btn btn-journal">Дневник</a>

                                <a asp-controller="Comments"
                                   asp-action="Ticket"
                                   asp-route-ticketId="@ticket.Id"
                                   class="btn btn-detail">Коментари</a>

                                <button type="button" 
                                        class="btn btn-report" 
                                        onclick="checkAndOpenReportModal(@ticket.Id)">
                                    Report
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast-glass">
    <span id="toastMessage"></span>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="closeReportModal()">&times;</span>
        <h2>Докладвай билет</h2>
        <form asp-controller="Reports" asp-action="SubmitReport" method="post">
            <input type="hidden" id="reportTicketId" name="ticketId" />
            <div class="form-group">
                <label for="reportReason">Причина за докладване:</label>
                <textarea id="reportReason" name="reason" class="glass-input" rows="4" required 
                          maxlength="300" 
                          placeholder="Моля, опишете защо докладвате този билет..."
                          oninput="updateCharCount(this)"></textarea>
                <div style="text-align: right; font-size: 0.8rem; color: #ccc; margin-top: 5px;">
                    <span id="charCount">0</span>/300
                </div>
            </div>
            <button type="submit" class="btn btn-report-submit">Изпрати</button>
        </form>
    </div>
</div>

<style>
    /* Global Styles */
    .page-title {
        text-align: center;
        font-size: 3rem;
        margin-bottom: 30px;
        color: white;
        font-weight: 800;
        text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        letter-spacing: -1px;
    }

    /* Controls (Search & Sort) */
    .controls-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 30px;
        max-width: 900px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        flex-wrap: wrap;
    }

    .glass-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 30px;
        color: white;
        font-size: 0.95rem;
        backdrop-filter: blur(10px);
        outline: none;
        transition: 0.3s;
        font-family: inherit;
        width: 250px;
    }

    .glass-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 30px;
        color: white;
        font-size: 0.95rem;
        backdrop-filter: blur(10px);
        outline: none;
        transition: 0.3s;
        font-family: inherit;
        width: auto;
        min-width: 200px;
        cursor: pointer;
        appearance: none; /* Remove default arrow */
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 15px top 50%;
        background-size: 12px auto;
        padding-right: 40px;
    }
    
    .glass-select option {
        background-color: #1e1e2f;
        color: white;
    }

    .btn-glass {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 12px 25px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
    }
    .btn-glass:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }

    .btn-clear {
        color: #ff6b6b; font-size: 1.5rem; text-decoration: none; transition: 0.3s;
    }
    .btn-clear:hover { color: #ff5252; transform: scale(1.1); }

    .no-tickets-glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        color: white;
        font-size: 1.2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .alert-glass {
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        backdrop-filter: blur(10px);
        font-weight: 600;
        text-align: center;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        animation: fadeIn 0.5s ease-out;
    }
    
    .error-alert {
        background: rgba(255, 82, 82, 0.2);
        border: 1px solid rgba(255, 82, 82, 0.4);
        color: #ff8a80;
    }
    
    .success-alert {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #b9f6ca;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Toast Notification */
    .toast-glass {
        visibility: hidden;
        min-width: 250px;
        background: rgba(255, 150, 60, 0.9); /* Orange warning color */
        color: white;
        text-align: center;
        border-radius: 50px;
        padding: 16px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(5px);
        opacity: 0;
        transition: opacity 0.5s, bottom 0.5s;
    }

    .toast-glass.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
    }

    /* Ticket Styles (Matching Index.cshtml) */
    .ticket-wrapper {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .real-ticket {
        display: flex;
        background: linear-gradient(145deg, #fafafa, #e6e6e6);
        border-radius: 15px;
        filter: drop-shadow(0 10px 10px rgba(0,0,0,0.15));
        overflow: hidden;
        cursor: default;
        transition: transform 0.3s ease, filter 0.3s ease;
        border: 1.5px solid #bbb;
        position: relative;
        font-weight: 600;
        user-select: none;
        color: #333;
        
        -webkit-mask: 
            radial-gradient(circle at center top, transparent 15px, black 15.5px) top center / 100% 51% no-repeat,
            radial-gradient(circle at center bottom, transparent 15px, black 15.5px) bottom center / 100% 51% no-repeat;
        mask: 
            radial-gradient(circle at center top, transparent 15px, black 15.5px) top center / 100% 51% no-repeat,
            radial-gradient(circle at center bottom, transparent 15px, black 15.5px) bottom center / 100% 51% no-repeat;
    }

    .real-ticket:hover {
        transform: translateY(-5px);
        filter: drop-shadow(0 18px 25px rgba(0,0,0,0.25));
        border-color: #4caf50;
    }

    .ticket-left, .ticket-right { padding: 25px 30px; flex: 1; position: relative; z-index: 10; }
    .ticket-left { 
        background: #e0f2f1; border-right: 1.5px dashed #999; 
        display: flex; flex-direction: column; justify-content: center; 
    }
    .ticket-left h2 { 
        font-size: 1.8rem; margin-bottom: 10px; color: #00796b; 
        text-shadow: 0 1px 1px #a0d4cf; 
    }
    .ticket-left p { font-size: 1rem; color: #004d40; margin: 4px 0; }

    .ticket-center-wrapper { width: 30px; display: flex; flex-direction: column; justify-content: center; margin: 0; background: transparent; }
    .ticket-center { width: 30px; height: 100%; background: repeating-linear-gradient( to bottom, transparent, transparent 8px, #999 8px, #999 10px ); position: relative; }

    .ticket-right { 
        background: #fff; display: flex; flex-direction: column; justify-content: space-between; 
        border-left: 1.5px dashed #999; 
    }
    
    .barcode { 
        width: 100%; height: 50px; 
        background: repeating-linear-gradient( to right, #000, #000 3px, #fff 3px, #fff 6px, #000 6px, #000 9px, #fff 9px, #fff 12px ); 
        opacity: 0.7; margin-bottom: 15px; 
    }

    .actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    
    .btn {
        padding: 8px 18px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; font-weight: 700;
        transition: 0.2s; border: none; cursor: pointer; color: white;
    }
    .btn-journal { background: #673ab7; box-shadow: 0 4px 10px rgba(103, 58, 183, 0.4); }
    .btn-journal:hover { background: #5e35b1; transform: translateY(-2px); }

    .btn-detail { background: #03a9f4; box-shadow: 0 4px 10px rgba(3, 169, 244, 0.4); }
    .btn-detail:hover { background: #0288d1; transform: translateY(-2px); }

    .btn-report { background: #e53935; box-shadow: 0 4px 10px rgba(229, 57, 53, 0.4); }
    .btn-report:hover { background: #c62828; transform: translateY(-2px); }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background: linear-gradient(135deg, #1e1e2f, #2a2a40);
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
    }

    .close-modal {
        position: absolute; top: 15px; right: 20px;
        font-size: 2rem; cursor: pointer; color: #ff6b6b;
        transition: 0.3s;
    }
    .close-modal:hover { color: #ff5252; transform: rotate(90deg); }

    .modal-content h2 { margin-bottom: 20px; text-align: center; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }

    #reportReason {
        width: 100%;
        resize: vertical;
        min-height: 100px;
    }

    .btn-report-submit { 
        background: #4caf50; width: 100%; padding: 12px; font-size: 1.1rem;
        box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
    }
    .btn-report-submit:hover { background: #388e3c; transform: translateY(-2px); }

</style>

<script>
    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }
    
    // Modal Logic
    function checkAndOpenReportModal(ticketId) {
        fetch(`/Reports/CheckReportStatus?ticketId=${ticketId}`)
            .then(response => response.json())
            .then(data => {
                if (data.reported) {
                    showToast("Вече сте изпратили доклад за този билет!");
                } else {
                    openReportModal(ticketId);
                }
            })
            .catch(error => {
                console.error("Error checking report status:", error);
                openReportModal(ticketId); // Fallback to open modal if check fails
            });
    }

    function showToast(message) {
        var x = document.getElementById("toast");
        document.getElementById("toastMessage").innerText = message;
        x.className = "toast-glass show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function openReportModal(ticketId) {
        document.getElementById('reportTicketId').value = ticketId;
        document.getElementById('reportModal').style.display = 'flex';
    }

    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        document.getElementById('reportReason').value = ''; // Clean up
        document.getElementById('charCount').textContent = '0';
    }

    function updateCharCount(textarea) {
        const currentLength = textarea.value.length;
        document.getElementById('charCount').textContent = currentLength;
    }

    // Close modal if clicking outside
    window.onclick = function(event) {
        var modal = document.getElementById('reportModal');
        if (event.target == modal) {
            closeReportModal();
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const select = document.getElementById('sortSelect');
        const container = document.querySelector('.ticket-wrapper');
        
        // Cache all tickets on load so we don't lose them when filtering
        const allTickets = Array.from(container.querySelectorAll('.real-ticket'));

        const userId = "@currentUserId";
        const storageKey = userId && userId !== ""
            ? `ticketSortMode_user_${userId}`
            : "ticketSortMode_guest";

        const savedMode = localStorage.getItem(storageKey) || 'random';
        if(select) {
            select.value = savedMode;

            select.addEventListener('change', () => {
                const mode = select.value;
                localStorage.setItem(storageKey, mode);
                applySort(mode);
            });
        }

        // Initial sort
        applySort(savedMode);

        function applySort(mode) {
            if(allTickets.length === 0) return;

            // Clear container
            container.innerHTML = '';

            const mine = shuffle(allTickets.filter(t => t.dataset.mine === "true"));
            const others = shuffle(allTickets.filter(t => t.dataset.mine === "false"));

            if (mode === "mineFirst") {
                mine.forEach(t => container.appendChild(t));
                others.forEach(t => container.appendChild(t));
            }
            else if (mode === "foreignOnly") {
                const foreignOnly = shuffle(others);
                // In generic public view, 'foreignOnly' might mean 'hide mine' or 'show only others'.
                foreignOnly.forEach(t => container.appendChild(t));
            }
            else {
                const mixed = shuffle([...mine, ...others]);
                mixed.forEach(t => container.appendChild(t));
            }
        }
    });
</script>